name: SEO Improvements - Auto PR

on:
  repository_dispatch:
    types: [seo-improvements]

jobs:
  apply-seo-improvements:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install beautifulsoup4 lxml

    - name: Display received actions
      run: |
        echo "ğŸ“¦ Received SEO improvements from unified-agent"
        echo "Number of actions: $(echo '${{ toJson(github.event.client_payload.actions) }}' | jq 'length')"

    - name: Apply SEO actions
      id: apply_actions
      env:
        ACTIONS_JSON: ${{ toJson(github.event.client_payload.actions) }}
      run: |
        python scripts/apply_seo_actions.py

    - name: Check for changes
      id: check_changes
      run: |
        if [[ -n $(git status --porcelain) ]]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "âœ… íŒŒì¼ ë³€ê²½ì‚¬í•­ ë°œê²¬"
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "âš ï¸  ë³€ê²½ì‚¬í•­ ì—†ìŒ"
        fi

    - name: Create Pull Request
      if: steps.check_changes.outputs.has_changes == 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Git ì„¤ì •
        git config user.name "SEO Agent Bot"
        git config user.email "seo-agent@users.noreply.github.com"

        # ë¸Œëœì¹˜ ìƒì„±
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        BRANCH_NAME="seo/improvements-${TIMESTAMP}"
        git checkout -b "$BRANCH_NAME"

        # Commit
        git add .
        git commit -m "ğŸ¤– [SEO Agent] Apply SEO improvements" -m "Generated by unified-agent" -m "Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

        # Push
        git push -u origin "$BRANCH_NAME"

        # PR ë³¸ë¬¸ ì‘ì„±
        cat > /tmp/pr_body.md << 'PRBODY'
        ## ğŸ¤– SEO Agent - Automated Improvements

        **Product**: `qr-generator`

        ## ğŸ“‹ Applied Actions

        PRBODY

        cat /tmp/applied_actions.md >> /tmp/pr_body.md 2>/dev/null || echo "See commit for details" >> /tmp/pr_body.md

        cat >> /tmp/pr_body.md << 'PRBODY'

        ## âœ… Test Checklist

        - [ ] ë©”íƒ€ íƒœê·¸ í™•ì¸ (view-source: ë˜ëŠ” ê°œë°œì ë„êµ¬)
        - [ ] í˜ì´ì§€ ë Œë”ë§ ì •ìƒ í™•ì¸
        - [ ] ë¹Œë“œ í…ŒìŠ¤íŠ¸ í†µê³¼
        - [ ] Lighthouse SEO ì ìˆ˜ í™•ì¸

        ## ğŸ“Š Expected Impact

        SEO ê°œì„  ì‚¬í•­ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. ë³€ê²½ ë‚´ìš©ì„ ê²€í† í•œ í›„ ë³‘í•©í•´ì£¼ì„¸ìš”.

        Generated by Unified Agent ğŸš€
        PRBODY

        # PR ìƒì„±
        gh pr create \
          --title "ğŸ” [SEO Agent] Auto improvements - $(date +%Y-%m-%d)" \
          --body-file /tmp/pr_body.md \
          --base main \
          --head "$BRANCH_NAME" \
          --label "seo,automated"

    - name: Summary
      if: always()
      run: |
        if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
          echo "âœ… SEO ê°œì„  ì‚¬í•­ì´ ì ìš©ë˜ê³  PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
        else
          echo "â„¹ï¸  ì ìš©í•  SEO ê°œì„  ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
        fi
